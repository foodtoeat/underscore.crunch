define(["jquery","backbone","underscore-plus","moment","base.app","text!./templates/items.utpl"],function(e,t,i,d,o,n){return t.View.extend({initialize:function(){this.load()},load:function(){this.fetch({success:e.proxy(this.render,this)})},fetch:function(e){this.model.fetchOrderItemOptions(e)},render:function(){this.$el.html(this.template({order:this.model,moment:d}))},template:i.template(n),events:{'change [data-type="field"]':"_changeValue",'change [data-field="is_total_price_calculated"]':"_changeAuto",'change [data-field="is_taxable"]':"_changeTaxable",'click [data-action="add"]':"_addItem",'click [data-action="delete-item"]':"_deleteItem",'change [data-type="item-option-field"]':"_changeOptionValue",'click [data-action="add-item-option"]':"_addItemOption",'click [data-action="delete-item-option"]':"_deleteItemOption",'click [data-action="save"]':"_clickSave"},deleted_items:[],deleted_item_options:[],_addItem:function(){this.model.items.add(new Models.OrderItem({order_token:this.model.get("access_token")})),this.render()},_deleteItem:function(t){var d=e(t.currentTarget),o=d.closest('[data-type="item-row"]').data("cid"),n=i.findWhere(this.model.items.models,{cid:o});this.model.items.remove(n),this.deleted_items.push(n),this.render()},_changeValue:function(t){var d=e(t.currentTarget),o=d.closest('[data-type="item-row"]').data("cid"),n=i.findWhere(this.model.items.models,{cid:o});n.set(d.attr("data-key"),d.val())},_changeAuto:function(t){var d=e(t.currentTarget),o=d.closest('[data-type="item-row"]').data("cid"),n=i.findWhere(this.model.items.models,{cid:o});n.set("is_total_price_calculated",d.prop("checked"))},_changeTaxable:function(t){var d=e(t.currentTarget),o=d.closest('[data-type="item-row"]').data("cid"),n=i.findWhere(this.model.items.models,{cid:o});n.set("is_taxable",d.prop("checked"))},_changeOptionValue:function(t){var d=e(t.currentTarget),o=d.closest('[data-type="item-option-row"]').data("cid"),n=i.findWhere(this.model.order_item_options.models,{cid:o});n.set(d.attr("data-key"),d.val())},_addItemOption:function(t){var d=e(t.currentTarget).closest('[data-type="item-row"]').data("cid"),o=i.findWhere(this.model.items.models,{cid:d}),n=new Models.OrderItemOption({order_item:o.id});n.item=o,this.model.order_item_options.add(n),this.render()},_deleteItemOption:function(t){var d=e(t.currentTarget),o=d.closest('[data-type="item-option-row"]').data("cid"),n=i.findWhere(this.model.order_item_options.models,{cid:o});this.model.order_item_options.remove(n),this.deleted_item_options.push(n),this.render()},_clickSave:function(t){var d=this,o=d.model.items.map(function(e){return function(t){e.setFilters({form:"admin"}),e.save({},t)}}),n=i.map(d.deleted_items,function(t){return function(o){t.setFilters({form:"admin"}),t.destroy(e.extend({},o,{success:function(){d.deleted_items=i.without(d.deleted_items,t),i.succeed(o)}}))}}),a=d.model.order_item_options.map(function(e){return function(t){return e.setFilters({form:"admin"}),e.item.id&&!e.item.id?(d.model.order_item_options.remove(e),i.finish(t)):(e.save({},t),void 0)}}),r=i.map(d.deleted_item_options,function(t){return function(o){t.setFilters({form:"admin"}),t.destroy(e.extend({},o,{success:function(){d.deleted_item_options=i.without(d.deleted_item_options,t),i.succeed(o)}}))}}),s=e(t.currentTarget).button("loading");i.crunch({pre:o.concat(n),post:{pre:a.concat(r),post:function(e){d.model.setFilters({form:"admin"}),d.model.fetch(e)}}})({success:function(){s.button("reset"),d.render()},error:function(){alert("There has been an error. Please check the fields"),s.button("reset")}})}})});